<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>–ö—Ä–∏–º–∏–Ω–∞–ª—å–Ω–∞—è –†–æ—Å—Å–∏—è ¬∑ –ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Helvetica Neue', sans-serif;
        }

        body {
            background: linear-gradient(145deg, #0a0010 0%, #1a0025 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 0;
            margin: 0;
            color: #f0e6ff;
            position: relative;
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at 20% 30%, rgba(170, 0, 255, 0.15) 0%, transparent 40%),
                        radial-gradient(circle at 80% 70%, rgba(120, 0, 200, 0.12) 0%, transparent 45%),
                        radial-gradient(circle at 40% 80%, rgba(200, 0, 255, 0.1) 0%, transparent 50%);
            animation: glowPulse 8s infinite alternate;
            pointer-events: none;
        }

        @keyframes glowPulse {
            0% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        #app {
            width: 100%;
            max-width: 480px;
            height: 100vh;
            max-height: 100vh;
            background: rgba(25, 0, 35, 0.6);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-left: 1px solid rgba(200, 0, 255, 0.3);
            border-right: 1px solid rgba(200, 0, 255, 0.3);
            box-shadow: 0 0 40px rgba(150, 0, 255, 0.3);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        #app::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border: 1px solid rgba(255, 0, 255, 0.1);
            box-shadow: inset 0 0 30px rgba(180, 0, 255, 0.2);
            pointer-events: none;
        }

        .screen {
            display: none;
            flex-direction: column;
            height: 100%;
            width: 100%;
        }

        .active-screen {
            display: flex;
        }

        .neon-header {
            padding: 16px 20px;
            background: rgba(20, 0, 30, 0.7);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid #b300ff;
            box-shadow: 0 0 20px #9900ff;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            z-index: 10;
        }

        .neon-title {
            font-size: 24px;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 4px;
            color: #ffffff;
            text-shadow: 0 0 10px #ff00de, 0 0 20px #c000ff, 0 0 30px #a000ff, 0 0 40px #8000ff;
            animation: flicker 3s infinite alternate;
        }

        @keyframes flicker {
            0% { text-shadow: 0 0 10px #ff00de, 0 0 20px #c000ff, 0 0 30px #a000ff; }
            100% { text-shadow: 0 0 15px #ff40ff, 0 0 25px #d020ff, 0 0 45px #a000ff, 0 0 55px #8000ff; }
        }

        .user-badge {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(80, 0, 130, 0.6);
            padding: 6px 12px;
            border-radius: 30px;
            border: 1px solid #d400ff;
            font-size: 14px;
            font-weight: bold;
        }

        .online-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #00ff88;
            box-shadow: 0 0 15px #00ff88;
            animation: pulseOnline 2s infinite;
        }

        @keyframes pulseOnline {
            0% { opacity: 0.8; transform: scale(1); }
            100% { opacity: 1; transform: scale(1.2); }
        }

        .content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .glass-card {
            background: rgba(50, 0, 70, 0.5);
            backdrop-filter: blur(12px);
            border-radius: 24px;
            padding: 20px;
            border: 1px solid rgba(200, 0, 255, 0.5);
            box-shadow: 0 8px 32px rgba(150, 0, 200, 0.3);
        }

        .input-field {
            width: 100%;
            padding: 16px 18px;
            background: rgba(20, 0, 30, 0.8);
            border: 2px solid #a020f0;
            border-radius: 40px;
            font-size: 16px;
            color: white;
            outline: none;
            transition: 0.2s;
            margin-bottom: 15px;
        }

        .input-field:focus {
            border-color: #ff40ff;
            box-shadow: 0 0 25px #bf00ff;
            background: rgba(40, 0, 50, 0.9);
        }

        .btn {
            background: linear-gradient(45deg, #6a0dad, #b300ff);
            border: none;
            border-radius: 40px;
            padding: 16px 20px;
            color: white;
            font-weight: bold;
            font-size: 16px;
            text-transform: uppercase;
            letter-spacing: 2px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 0 20px #8a2be2;
            transition: 0.2s;
            cursor: pointer;
        }

        .btn:active {
            transform: scale(0.97);
            box-shadow: 0 0 35px #bf00ff;
        }

        .id-display {
            background: rgba(0, 0, 0, 0.6);
            padding: 15px;
            border-radius: 20px;
            border: 1px dashed #ff44ff;
            font-size: 28px;
            font-weight: 800;
            text-align: center;
            letter-spacing: 8px;
            color: #ffffff;
            text-shadow: 0 0 15px cyan;
            margin: 10px 0;
        }

        .chat-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .chat-item {
            background: rgba(75, 0, 130, 0.5);
            backdrop-filter: blur(5px);
            padding: 16px;
            border-radius: 20px;
            border-left: 8px solid #b300ff;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: 0.2s;
        }

        .chat-item:active {
            background: rgba(100, 0, 150, 0.8);
            transform: scale(0.98);
        }

        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        /* –†–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å –¥–∞—Ç */
        .date-separator {
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 15px 0;
            position: relative;
        }

        .date-separator::before {
            content: '';
            flex: 1;
            height: 1px;
            background: linear-gradient(90deg, transparent, #c061ff, transparent);
            margin-right: 15px;
        }

        .date-separator::after {
            content: '';
            flex: 1;
            height: 1px;
            background: linear-gradient(90deg, transparent, #c061ff, transparent);
            margin-left: 15px;
        }

        .date-text {
            background: rgba(100, 0, 150, 0.6);
            backdrop-filter: blur(10px);
            padding: 8px 18px;
            border-radius: 30px;
            font-size: 13px;
            font-weight: bold;
            color: #ffffff;
            border: 1px solid #e580ff;
            box-shadow: 0 0 15px #b300ff;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .message-wrapper {
            max-width: 80%;
            align-self: flex-start;
            position: relative;
            margin-bottom: 4px;
        }

        .my-message-wrapper {
            align-self: flex-end;
        }

        .message {
            padding: 12px 16px;
            border-radius: 24px;
            position: relative;
            word-break: break-word;
            transition: 0.2s;
        }

        .my-message {
            background: linear-gradient(145deg, #7a1fa0, #4a0072);
            border-bottom-right-radius: 4px;
            box-shadow: 0 0 20px #b300ff70;
            color: white;
        }

        .other-message {
            background: rgba(40, 0, 60, 0.8);
            border: 1px solid #cc66ff;
            border-bottom-left-radius: 4px;
            color: white;
        }

        .message-time {
            font-size: 11px;
            color: #ccccff;
            margin-top: 5px;
            text-align: right;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 4px;
        }

        .last-seen {
            font-size: 12px;
            color: #bb99ff;
        }

        .bottom-nav {
            display: flex;
            justify-content: space-around;
            background: rgba(16, 0, 20, 0.9);
            backdrop-filter: blur(15px);
            padding: 12px 10px;
            border-top: 1px solid #a64dff;
            box-shadow: 0 -5px 30px #6a0dad;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: #d0b0ff;
            font-size: 12px;
            gap: 4px;
            transition: 0.2s;
            cursor: pointer;
        }

        .nav-item.active {
            color: #ffbbff;
            text-shadow: 0 0 15px #ff00ff;
        }

        .nav-icon {
            font-size: 22px;
        }

        .accounts-grid {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .account-item {
            background: rgba(80, 0, 120, 0.4);
            padding: 15px;
            border-radius: 18px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid #c061ff;
        }

        .hidden {
            display: none !important;
        }

        .context-menu {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(30, 0, 40, 0.95);
            backdrop-filter: blur(20px);
            border-top: 2px solid #b300ff;
            border-radius: 30px 30px 0 0;
            padding: 25px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            z-index: 1000;
            animation: slideUp 0.3s;
        }

        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }

        .context-menu-item {
            padding: 18px;
            background: rgba(100, 0, 150, 0.3);
            border-radius: 20px;
            text-align: center;
            font-size: 18px;
            font-weight: bold;
            color: white;
            border: 1px solid #d400ff;
            cursor: pointer;
        }

        .context-menu-item.delete {
            color: #ff9999;
            border-color: #ff4444;
        }

        .context-menu-item:active {
            background: rgba(150, 0, 200, 0.5);
        }

        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 999;
        }

        .read-status {
            font-size: 12px;
            color: #aaffaa;
            margin-left: 4px;
        }

        /* –ê–¥–∞–ø—Ç–∞—Ü–∏—è –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö */
        @media (max-width: 480px) {
            .neon-title {
                font-size: 20px;
            }
            
            .message-wrapper {
                max-width: 85%;
            }
            
            .date-text {
                font-size: 12px;
                padding: 6px 14px;
            }
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- –≠–ö–†–ê–ù –í–•–û–î–ê / –†–ï–ì–ò–°–¢–†–ê–¶–ò–ò -->
        <div id="auth-screen" class="screen active-screen">
            <div class="neon-header">
                <span class="neon-title">–ö–†–ò–ú–ò–ù–ê–õ–¨–ù–ê–Ø –†–û–°–°–ò–Ø</span>
            </div>
            <div class="content">
                <div class="glass-card" style="margin-top: 30px;">
                    <h2 style="margin-bottom: 20px; text-align: center; text-shadow: 0 0 10px violet;">–í–æ–π—Ç–∏ –≤ –∫—Ä–∏–º–∏–Ω–∞–ª</h2>
                    <input type="text" id="login-username" class="input-field" placeholder="–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è" autocomplete="off">
                    <button id="login-btn" class="btn">–í–æ–π—Ç–∏ / –°–æ–∑–¥–∞—Ç—å</button>
                </div>
                <div style="text-align: center; margin-top: 20px; color: #d0a0ff;">
                    –í–∞–º –±—É–¥–µ—Ç –ø—Ä–∏—Å–≤–æ–µ–Ω —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID ‚ù§Ô∏è‚Äçüî•
                </div>
            </div>
        </div>

        <!-- –û–°–ù–û–í–ù–û–ô –≠–ö–†–ê–ù –ß–ê–¢–û–í -->
        <div id="main-screen" class="screen">
            <div class="neon-header">
                <span class="neon-title">–ú–ï–°–°–ï–ù–î–ñ–ï–† –ö–†</span>
                <div id="current-user-badge" class="user-badge">
                    <span id="online-indicator-header" class="online-indicator"></span>
                    <span id="current-username">...</span>
                </div>
            </div>
            
            <div class="content" id="main-content">
                <!-- –°–ø–∏—Å–æ–∫ –¥–∏–∞–ª–æ–≥–æ–≤ -->
                <div id="chats-list-container">
                    <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                        <input type="text" id="search-user-id" class="input-field" placeholder="–í–≤–µ–¥–∏—Ç–µ ID —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞" style="margin-bottom: 0;">
                        <button id="start-chat-btn" class="btn" style="width: auto; padding: 16px 20px;">‚ûï</button>
                    </div>
                    <div id="chats-list" class="chat-list"></div>
                </div>

                <!-- –û–∫–Ω–æ –ø–µ—Ä–µ–ø–∏—Å–∫–∏ -->
                <div id="chat-window" class="hidden" style="height: 100%; display: flex; flex-direction: column;">
                    <div style="display: flex; align-items: center; gap: 15px; padding-bottom: 15px; border-bottom: 1px solid #b300ff;">
                        <button id="back-to-chats" style="background: none; border: none; font-size: 28px; color: #fff; cursor: pointer;">‚Üê</button>
                        <div>
                            <div style="font-weight: bold; font-size: 18px;" id="chat-partner-name">ID: </div>
                            <div class="last-seen" id="chat-partner-status">–ø–æ—Å–ª–µ–¥–Ω–∏–π —Ä–∞–∑: ...</div>
                        </div>
                    </div>
                    
                    <div id="messages-list" class="messages-container">
                        <!-- –°–æ–æ–±—â–µ–Ω–∏—è —Å –¥–∞—Ç–∞–º–∏ –ø–æ–¥–≥—Ä—É–∂–∞—é—Ç—Å—è —Å—é–¥–∞ -->
                    </div>

                    <div id="typing-notification" class="typing-indicator hidden" style="margin-left: 15px; margin-bottom: 5px; color: #d4a0ff; font-style: italic; display: flex; align-items: center; gap: 5px; padding: 8px 15px; background: rgba(100, 0, 150, 0.3); border-radius: 30px; align-self: flex-start;">
                        <span>‚úçÔ∏è –ü–µ—á–∞—Ç–∞–µ—Ç...</span>
                    </div>

                    <div style="display: flex; gap: 12px; padding: 15px 0;">
                        <input type="text" id="message-input" class="input-field" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." style="margin-bottom: 0;">
                        <button id="send-message-btn" class="btn" style="width: auto; padding: 16px 24px;">‚û§</button>
                    </div>
                </div>
            </div>

            <div class="bottom-nav">
                <div class="nav-item active" id="nav-chats">
                    <span class="nav-icon">üí¨</span>
                    <span>–ß–∞—Ç—ã</span>
                </div>
                <div class="nav-item" id="nav-settings">
                    <span class="nav-icon">‚öôÔ∏è</span>
                    <span>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</span>
                </div>
            </div>
        </div>

        <!-- –≠–ö–†–ê–ù –ù–ê–°–¢–†–û–ï–ö -->
        <div id="settings-screen" class="screen">
            <div class="neon-header">
                <span class="neon-title">–ù–ê–°–¢–†–û–ô–ö–ò</span>
                <div class="user-badge">
                    <span id="settings-username">user</span>
                </div>
            </div>
            <div class="content">
                <div class="glass-card">
                    <h3 style="margin-bottom: 15px;">üîÆ –¢–≤–æ–π —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID</h3>
                    <div id="user-unique-id" class="id-display">00000</div>
                    <p style="margin-top: 15px; color: #e6ccff;">–ü–æ —ç—Ç–æ–º—É ID —Ç–µ–±—è –º–æ–≥—É—Ç –Ω–∞–π—Ç–∏ –¥—Ä—É–≥–∏–µ</p>
                </div>

                <div class="glass-card" style="margin-top: 20px;">
                    <h3 style="margin-bottom: 20px;">üë• –°–ø–∏—Å–æ–∫ –∞–∫–∫–∞—É–Ω—Ç–æ–≤</h3>
                    <div id="accounts-list-container" class="accounts-grid"></div>
                    <button id="add-new-account-btn" class="btn" style="margin-top: 20px;">‚ûï –î–æ–±–∞–≤–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç</button>
                </div>

                <button id="logout-from-settings" class="btn" style="margin-top: 20px; background: linear-gradient(45deg, #4b0082, #8a2be2);">–í—ã–π—Ç–∏</button>
            </div>
            <div class="bottom-nav">
                <div class="nav-item" id="nav-chats-from-settings">
                    <span class="nav-icon">üí¨</span>
                    <span>–ß–∞—Ç—ã</span>
                </div>
                <div class="nav-item active">
                    <span class="nav-icon">‚öôÔ∏è</span>
                    <span>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</span>
                </div>
            </div>
        </div>
    </div>

    <!-- –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π -->
    <div id="context-menu-overlay" class="overlay hidden"></div>
    <div id="context-menu" class="context-menu hidden">
        <div class="context-menu-item delete" id="delete-message-btn">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ</div>
        <div class="context-menu-item" id="cancel-context-menu">‚ùå –û—Ç–º–µ–Ω–∞</div>
    </div>

    <script>
        // üî• FIREBASE –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø
        const firebaseConfig = {
            apiKey: "AIzaSyAu_wfaRhTsWNbsyFYmEigopqJck7ynxlU",
            authDomain: "messeger-0wo2h4.firebaseapp.com",
            databaseURL: "https://messeger-0wo2h4-default-rtdb.firebaseio.com",
            projectId: "messeger-0wo2h4",
            storageBucket: "messeger-0wo2h4.firebasestorage.app",
            messagingSenderId: "1057251395030",
            appId: "1:1057251395030:web:86f8f718ed938055e29077"
        };

        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // ================== –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ==================
        let currentUser = null;
        let currentChatPartner = null;
        let allAccounts = [];
        let selectedMessageId = null;
        let currentChatId = null;
        let typingTimeout = null;
        let presenceRef = null;

        // –≠–ª–µ–º–µ–Ω—Ç—ã DOM
        const authScreen = document.getElementById('auth-screen');
        const mainScreen = document.getElementById('main-screen');
        const settingsScreen = document.getElementById('settings-screen');
        const loginBtn = document.getElementById('login-btn');
        const loginUsername = document.getElementById('login-username');
        const currentUsernameSpan = document.getElementById('current-username');
        const settingsUsernameSpan = document.getElementById('settings-username');
        const userUniqueIdSpan = document.getElementById('user-unique-id');
        const chatsListEl = document.getElementById('chats-list');
        const chatWindow = document.getElementById('chat-window');
        const chatsListContainer = document.getElementById('chats-list-container');
        const messagesListEl = document.getElementById('messages-list');
        const messageInput = document.getElementById('message-input');
        const sendMsgBtn = document.getElementById('send-message-btn');
        const searchUserId = document.getElementById('search-user-id');
        const startChatBtn = document.getElementById('start-chat-btn');
        const backToChats = document.getElementById('back-to-chats');
        const chatPartnerName = document.getElementById('chat-partner-name');
        const chatPartnerStatus = document.getElementById('chat-partner-status');
        const typingNotification = document.getElementById('typing-notification');

        // –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é
        const contextMenu = document.getElementById('context-menu');
        const contextMenuOverlay = document.getElementById('context-menu-overlay');
        const deleteMessageBtn = document.getElementById('delete-message-btn');
        const cancelContextMenu = document.getElementById('cancel-context-menu');

        // –ù–∞–≤–∏–≥–∞—Ü–∏—è
        document.getElementById('nav-settings').addEventListener('click', () => showSettingsScreen());
        document.getElementById('nav-chats-from-settings').addEventListener('click', () => showMainScreen());
        document.getElementById('nav-chats').addEventListener('click', () => showMainScreen());
        document.getElementById('logout-from-settings').addEventListener('click', logout);
        document.getElementById('add-new-account-btn').addEventListener('click', () => { logout(); });

        backToChats.addEventListener('click', () => {
            chatWindow.classList.add('hidden');
            chatsListContainer.classList.remove('hidden');
            if (currentChatPartner) {
                database.ref(`users/${currentChatPartner}`).off();
                currentChatPartner = null;
            }
            if (currentChatId) {
                database.ref(`messages/${currentChatId}`).off();
                database.ref(`typing/${currentChatId}`).off();
                currentChatId = null;
            }
        });

        // ================== –§–£–ù–ö–¶–ò–ò –§–û–†–ú–ê–¢–ò–†–û–í–ê–ù–ò–Ø –î–ê–¢–´ ==================
        function getMoscowTime() {
            const now = new Date();
            const mskOffset = 3 * 60;
            const localOffset = now.getTimezoneOffset();
            return new Date(now.getTime() + (mskOffset + localOffset) * 60000);
        }

        function formatDateForSeparator(timestamp) {
            const date = new Date(timestamp);
            const now = getMoscowTime();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);
            const messageDate = new Date(date.getFullYear(), date.getMonth(), date.getDate());

            if (messageDate.getTime() === today.getTime()) {
                return '–°–ï–ì–û–î–ù–Ø';
            } else if (messageDate.getTime() === yesterday.getTime()) {
                return '–í–ß–ï–†–ê';
            } else {
                const day = date.getDate().toString().padStart(2, '0');
                const month = (date.getMonth() + 1).toString().padStart(2, '0');
                const year = date.getFullYear();
                return `${day}.${month}.${year}`;
            }
        }

        function formatFullDate(timestamp) {
            const date = new Date(timestamp);
            const day = date.getDate().toString().padStart(2, '0');
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const year = date.getFullYear();
            const hours = date.getHours().toString().padStart(2, '0');
            const minutes = date.getMinutes().toString().padStart(2, '0');
            return `${day}.${month}.${year} ${hours}:${minutes}`;
        }

        function formatLastSeen(timestamp) {
            if (!timestamp) return '–Ω–∏–∫–æ–≥–¥–∞';
            const last = new Date(timestamp);
            const now = getMoscowTime();
            const diffMs = now - last;
            const diffSec = Math.floor(diffMs / 1000);
            const diffMin = Math.floor(diffSec / 60);
            const diffHours = Math.floor(diffMin / 60);
            const diffDays = Math.floor(diffHours / 24);
            
            if (diffSec < 5) return '—Ç–æ–ª—å–∫–æ —á—Ç–æ';
            if (diffSec < 60) return `${diffSec} —Å–µ–∫ –Ω–∞–∑–∞–¥`;
            if (diffMin < 60) return `${diffMin} –º–∏–Ω ${diffSec % 60} —Å–µ–∫ –Ω–∞–∑–∞–¥`;
            if (diffHours < 24) return `${diffHours} —á ${diffMin % 60} –º–∏–Ω –Ω–∞–∑–∞–¥`;
            if (diffDays === 1) return '–≤—á–µ—Ä–∞';
            if (diffDays < 7) return `${diffDays} –¥–Ω –Ω–∞–∑–∞–¥`;
            
            const day = last.getDate().toString().padStart(2, '0');
            const month = (last.getMonth() + 1).toString().padStart(2, '0');
            const year = last.getFullYear();
            const hours = last.getHours().toString().padStart(2, '0');
            const minutes = last.getMinutes().toString().padStart(2, '0');
            return `${day}.${month}.${year} ${hours}:${minutes}`;
        }

        // ================== –ì–ï–ù–ï–†–ê–¶–ò–Ø ID ==================
        function generateUniqueId() {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ0123456789';
            let id = '';
            for (let i = 0; i < 5; i++) {
                id += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return id;
        }

        // ================== –†–ê–ë–û–¢–ê –° –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø–ú–ò ==================
        async function loginUser(username) {
            if (!username.trim()) return alert('–í–≤–µ–¥–∏—Ç–µ –∏–º—è');
            const usersRef = database.ref('users');
            const snapshot = await usersRef.orderByChild('name').equalTo(username).once('value');
            let userData;
            let userId;

            if (snapshot.exists()) {
                const entries = Object.entries(snapshot.val());
                userId = entries[0][0];
                userData = entries[0][1];
            } else {
                userId = generateUniqueId();
                const idCheck = await usersRef.child(userId).once('value');
                if (idCheck.exists()) {
                    userId = generateUniqueId();
                }
                userData = {
                    name: username,
                    id: userId,
                    lastSeen: firebase.database.ServerValue.TIMESTAMP,
                    online: true
                };
                await usersRef.child(userId).set(userData);
            }

            currentUser = { ...userData, uid: userId };
            
            let accounts = JSON.parse(localStorage.getItem('criminal_accounts') || '[]');
            if (!accounts.find(acc => acc.uid === userId)) {
                accounts.push({ uid: userId, name: username });
                localStorage.setItem('criminal_accounts', JSON.stringify(accounts));
            }
            localStorage.setItem('current_account', JSON.stringify({ uid: userId, name: username }));

            await setupPresence(userId);
            loadAllAccounts();
            updateUIForUser();
            showMainScreen();
        }

        async function setupPresence(uid) {
            if (!uid) return;
            
            const userStatusRef = database.ref(`users/${uid}`);
            const connectedRef = database.ref('.info/connected');
            
            if (presenceRef) {
                connectedRef.off('value', presenceRef);
            }
            
            presenceRef = await connectedRef.on('value', async (snap) => {
                if (snap.val() === true) {
                    await userStatusRef.update({
                        online: true,
                        lastSeen: firebase.database.ServerValue.TIMESTAMP
                    });
                    
                    userStatusRef.onDisconnect().update({
                        online: false,
                        lastSeen: firebase.database.ServerValue.TIMESTAMP
                    });
                }
            });
        }

        function loadAllAccounts() {
            const stored = localStorage.getItem('criminal_accounts');
            allAccounts = stored ? JSON.parse(stored) : [];
            renderAccountsList();
        }

        function renderAccountsList() {
            const container = document.getElementById('accounts-list-container');
            if (!container) return;
            let html = '';
            allAccounts.forEach(acc => {
                html += `<div class="account-item">
                            <span style="font-weight: bold;">${acc.name}</span>
                            <span style="background: #6a0dad; padding: 6px 12px; border-radius: 30px;">ID: ${acc.uid}</span>
                            <button onclick="switchAccount('${acc.uid}')" class="btn" style="padding: 8px 16px;">üîÅ</button>
                        </div>`;
            });
            container.innerHTML = html || '<p style="color: #ccc;">–ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –∞–∫–∫–∞—É–Ω—Ç–æ–≤</p>';
        }

        window.switchAccount = async function(uid) {
            const usersRef = database.ref('users');
            const snap = await usersRef.child(uid).once('value');
            if (snap.exists()) {
                const userData = snap.val();
                currentUser = { ...userData, uid };
                localStorage.setItem('current_account', JSON.stringify({ uid, name: userData.name }));
                await setupPresence(uid);
                updateUIForUser();
                showMainScreen();
            }
        };

        function updateUIForUser() {
            if (currentUser) {
                currentUsernameSpan.textContent = currentUser.name;
                settingsUsernameSpan.textContent = currentUser.name;
                userUniqueIdSpan.textContent = currentUser.id;
            }
        }

        // ================== –ó–ê–ì–†–£–ó–ö–ê –ß–ê–¢–û–í ==================
        function loadChats() {
            if (!currentUser) return;
            const userId = currentUser.uid;
            const chatsRef = database.ref('chats');

            chatsRef.orderByChild(`participants/${userId}`).equalTo(true).on('value', async (snapshot) => {
                if (!snapshot.exists()) {
                    chatsListEl.innerHTML = '<div style="color: #bb99ff; text-align: center;">–ù–µ—Ç —á–∞—Ç–æ–≤. –ù–∞—á–Ω–∏—Ç–µ –ø–µ—Ä–µ–ø–∏—Å–∫—É –ø–æ ID!</div>';
                    return;
                }
                
                const chats = snapshot.val();
                const chatPromises = [];
                
                for (const chatId in chats) {
                    const chat = chats[chatId];
                    const participants = Object.keys(chat.participants || {});
                    const partnerId = participants.find(p => p !== userId);
                    
                    if (partnerId) {
                        chatPromises.push(
                            database.ref(`users/${partnerId}`).once('value').then(partnerSnap => {
                                if (partnerSnap.exists()) {
                                    const pData = partnerSnap.val();
                                    const lastMessage = chat.lastMessage || '';
                                    const lastTime = chat.lastTime ? formatLastSeen(chat.lastTime) : '';
                                    
                                    return {
                                        chatId,
                                        partnerId,
                                        partnerName: pData.name,
                                        lastMessage,
                                        lastTime,
                                        lastTimestamp: chat.lastTime || 0
                                    };
                                }
                            })
                        );
                    }
                }
                
                const chatData = (await Promise.all(chatPromises)).filter(Boolean);
                chatData.sort((a, b) => (b.lastTimestamp || 0) - (a.lastTimestamp || 0));
                
                let chatsHtml = '';
                chatData.forEach(chat => {
                    chatsHtml += `<div class="chat-item" onclick="openChat('${chat.partnerId}')" data-chatid="${chat.chatId}">
                                    <div>
                                        <div style="font-weight: bold; margin-bottom: 5px;">${chat.partnerName}</div>
                                        <div style="font-size: 13px; color: #dec5ff;">ID: ${chat.partnerId}</div>
                                        <div style="font-size: 12px; color: #aa88cc;">
                                            ${chat.lastMessage ? chat.lastMessage.substring(0, 25) + (chat.lastMessage.length > 25 ? '...' : '') : '–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π'}
                                        </div>
                                    </div>
                                    <div style="display: flex; flex-direction: column; align-items: flex-end;">
                                        <div style="font-size: 24px;">üí¨</div>
                                        <div style="font-size: 11px; color: #bb99ff; margin-top: 5px;">${chat.lastTime}</div>
                                    </div>
                                </div>`;
                });
                
                chatsListEl.innerHTML = chatsHtml || '<div style="color: #bb99ff;">–ß–∞—Ç–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</div>';
            });
        }

        // ================== –û–¢–ö–†–´–¢–¨ –ß–ê–¢ ==================
        window.openChat = async function(partnerId) {
            currentChatPartner = partnerId;
            currentChatId = generateChatId(currentUser.uid, partnerId);
            
            chatWindow.classList.remove('hidden');
            chatsListContainer.classList.add('hidden');

            const userSnap = await database.ref(`users/${partnerId}`).once('value');
            if (userSnap.exists()) {
                const pData = userSnap.val();
                chatPartnerName.textContent = `${pData.name} (${partnerId})`;
            }

            database.ref(`users/${partnerId}`).off();
            database.ref(`users/${partnerId}`).on('value', (snap) => {
                const user = snap.val();
                if (user) {
                    if (user.online === true) {
                        chatPartnerStatus.innerHTML = '<span style="color: #00ff88;">‚óè</span> –≤ —Å–µ—Ç–∏';
                    } else {
                        chatPartnerStatus.textContent = `–±—ã–ª(–∞) ${formatLastSeen(user.lastSeen)}`;
                    }
                }
            });

            const messagesRef = database.ref(`messages/${currentChatId}`);
            messagesRef.off();
            messagesRef.orderByChild('timestamp').on('value', (snap) => {
                if (snap.exists()) {
                    renderMessagesWithDates(snap.val());
                } else {
                    messagesListEl.innerHTML = '<div style="color: #aaa; text-align: center; margin-top: 50px;">–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π. –ù–∞–ø–∏—à–∏—Ç–µ –ø–µ—Ä–≤–æ–µ!</div>';
                }
            });

            database.ref(`typing/${currentChatId}/${partnerId}`).off();
            database.ref(`typing/${currentChatId}/${partnerId}`).on('value', (snap) => {
                if (snap.val() === true) {
                    typingNotification.classList.remove('hidden');
                } else {
                    typingNotification.classList.add('hidden');
                }
            });
            
            markMessagesAsRead(currentChatId, partnerId);
        };

        function generateChatId(uid1, uid2) {
            return [uid1, uid2].sort().join('_');
        }

        async function markMessagesAsRead(chatId, partnerId) {
            if (!currentUser) return;
            const messagesRef = database.ref(`messages/${chatId}`);
            const snapshot = await messagesRef.orderByChild('read').equalTo(false).once('value');
            
            if (snapshot.exists()) {
                const updates = {};
                snapshot.forEach(child => {
                    const message = child.val();
                    if (message.sender === partnerId) {
                        updates[`${child.key}/read`] = true;
                    }
                });
                
                if (Object.keys(updates).length > 0) {
                    await messagesRef.update(updates);
                }
            }
        }

        // ================== –û–¢–û–ë–†–ê–ñ–ï–ù–ò–ï –°–û–û–ë–©–ï–ù–ò–ô –° –î–ê–¢–ê–ú–ò ==================
        function renderMessagesWithDates(messagesObj) {
            if (!messagesObj) return;
            
            const messages = Object.entries(messagesObj)
                .map(([id, msg]) => ({ id, ...msg }))
                .sort((a, b) => a.timestamp - b.timestamp);
            
            let html = '';
            let currentDate = null;
            
            messages.forEach((msg, index) => {
                const msgDate = new Date(msg.timestamp);
                const dateKey = `${msgDate.getDate()}_${msgDate.getMonth()}_${msgDate.getFullYear()}`;
                
                // –î–æ–±–∞–≤–ª—è–µ–º —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å –¥–∞—Ç—ã –µ—Å–ª–∏ –¥–µ–Ω—å –∏–∑–º–µ–Ω–∏–ª—Å—è
                if (dateKey !== currentDate) {
                    currentDate = dateKey;
                    const dateText = formatDateForSeparator(msg.timestamp);
                    html += `<div class="date-separator">
                                <span class="date-text">${dateText}</span>
                            </div>`;
                }
                
                const isMy = msg.sender === currentUser.uid;
                const time = new Date(msg.timestamp).toLocaleTimeString('ru-RU', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                
                const fullDate = formatFullDate(msg.timestamp);
                
                html += `<div class="message-wrapper ${isMy ? 'my-message-wrapper' : ''}" 
                              data-message-id="${msg.id}" 
                              data-sender="${msg.sender}"
                              oncontextmenu="showMessageMenu('${msg.id}', event)"
                              ontouchstart="touchStart('${msg.id}', event)"
                              ontouchend="touchEnd()">
                            <div class="message ${isMy ? 'my-message' : 'other-message'}">
                                ${msg.text}
                                <div class="message-time" title="${fullDate}">
                                    ${time}
                                    ${isMy ? (msg.read ? '<span class="read-status">‚úì‚úì</span>' : '<span class="read-status">‚úì</span>') : ''}
                                </div>
                            </div>
                        </div>`;
            });
            
            messagesListEl.innerHTML = html;
            messagesListEl.scrollTop = messagesListEl.scrollHeight;
        }

        // ================== –£–î–ê–õ–ï–ù–ò–ï –°–û–û–ë–©–ï–ù–ò–Ø ==================
        window.showMessageMenu = function(messageId, event) {
            if (event) {
                event.preventDefault();
                event.stopPropagation();
            }
            
            selectedMessageId = messageId;
            contextMenu.classList.remove('hidden');
            contextMenuOverlay.classList.remove('hidden');
        };

        let touchTimer;
        window.touchStart = function(messageId, event) {
            touchTimer = setTimeout(() => {
                showMessageMenu(messageId, event);
            }, 500);
        };

        window.touchEnd = function() {
            clearTimeout(touchTimer);
        };

        async function deleteSelectedMessage() {
            if (!selectedMessageId || !currentChatId) return;
            
            try {
                await database.ref(`messages/${currentChatId}/${selectedMessageId}`).remove();
                closeContextMenu();
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è:', error);
                alert('–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ');
            }
        }

        function closeContextMenu() {
            contextMenu.classList.add('hidden');
            contextMenuOverlay.classList.add('hidden');
            selectedMessageId = null;
        }

        // ================== –û–¢–ü–†–ê–í–ö–ê –°–û–û–ë–©–ï–ù–ò–Ø ==================
        sendMsgBtn.addEventListener('click', sendMessage);
        
        messageInput.addEventListener('input', () => {
            if (currentChatPartner && currentUser) {
                const chatId = generateChatId(currentUser.uid, currentChatPartner);
                database.ref(`typing/${chatId}/${currentUser.uid}`).set(true);
                
                if (typingTimeout) clearTimeout(typingTimeout);
                typingTimeout = setTimeout(() => {
                    database.ref(`typing/${chatId}/${currentUser.uid}`).remove();
                }, 2000);
            }
        });

        async function sendMessage() {
            const text = messageInput.value.trim();
            if (!text || !currentChatPartner || !currentUser) return;

            const chatId = generateChatId(currentUser.uid, currentChatPartner);
            const messageRef = database.ref(`messages/${chatId}`).push();
            
            await messageRef.set({
                text: text,
                sender: currentUser.uid,
                timestamp: firebase.database.ServerValue.TIMESTAMP,
                read: false
            });

            await database.ref(`chats/${chatId}`).update({
                participants: {
                    [currentUser.uid]: true,
                    [currentChatPartner]: true
                },
                lastMessage: text,
                lastTime: firebase.database.ServerValue.TIMESTAMP
            });

            messageInput.value = '';
            database.ref(`typing/${chatId}/${currentUser.uid}`).remove();
        }

        // ================== –ù–ê–ß–ê–¢–¨ –ß–ê–¢ –ü–û ID ==================
        startChatBtn.addEventListener('click', async () => {
            const targetId = searchUserId.value.trim().toUpperCase();
            if (!targetId) return alert('–í–≤–µ–¥–∏—Ç–µ ID');
            if (targetId === currentUser.id) return alert('–≠—Ç–æ –≤–∞—à —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π ID');
            
            const userSnap = await database.ref(`users/${targetId}`).once('value');
            if (userSnap.exists()) {
                openChat(targetId);
                searchUserId.value = '';
            } else {
                alert('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º ID –Ω–µ –Ω–∞–π–¥–µ–Ω');
            }
        });

        // ================== –í–´–•–û–î ==================
        async function logout() {
            if (currentUser) {
                await database.ref(`users/${currentUser.uid}`).update({
                    online: false,
                    lastSeen: firebase.database.ServerValue.TIMESTAMP
                });
                if (presenceRef) {
                    database.ref('.info/connected').off('value', presenceRef);
                }
                currentUser = null;
            }
            authScreen.classList.add('active-screen');
            mainScreen.classList.remove('active-screen');
            settingsScreen.classList.remove('active-screen');
        }

        // ================== –ü–û–ö–ê–ó –≠–ö–†–ê–ù–û–í ==================
        function showMainScreen() {
            authScreen.classList.remove('active-screen');
            mainScreen.classList.add('active-screen');
            settingsScreen.classList.remove('active-screen');
            chatWindow.classList.add('hidden');
            chatsListContainer.classList.remove('hidden');
            if (currentUser) {
                loadChats();
                updateUIForUser();
            }
        }

        function showSettingsScreen() {
            authScreen.classList.remove('active-screen');
            mainScreen.classList.remove('active-screen');
            settingsScreen.classList.add('active-screen');
            if (currentUser) {
                userUniqueIdSpan.textContent = currentUser.id;
                settingsUsernameSpan.textContent = currentUser.name;
                loadAllAccounts();
            }
        }

        // ================== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ==================
        window.onload = async () => {
            const savedAccount = localStorage.getItem('current_account');
            if (savedAccount) {
                const acc = JSON.parse(savedAccount);
                const userSnap = await database.ref(`users/${acc.uid}`).once('value');
                if (userSnap.exists()) {
                    const userData = userSnap.val();
                    currentUser = { ...userData, uid: acc.uid };
                    await setupPresence(acc.uid);
                    updateUIForUser();
                    showMainScreen();
                } else {
                    localStorage.removeItem('current_account');
                }
            }

            loginBtn.addEventListener('click', () => loginUser(loginUsername.value));
            loginUsername.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') loginUser(loginUsername.value);
            });

            deleteMessageBtn.addEventListener('click', deleteSelectedMessage);
            cancelContextMenu.addEventListener('click', closeContextMenu);
            contextMenuOverlay.addEventListener('click', closeContextMenu);

            loadAllAccounts();
        };

        window.addEventListener('beforeunload', async function() {
            if (currentUser) {
                await database.ref(`users/${currentUser.uid}`).update({
                    online: false,
                    lastSeen: firebase.database.ServerValue.TIMESTAMP
                });
            }
        });
    </script>
</body>
</html>

