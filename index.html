<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>–ö—Ä–∏–º–∏–Ω–∞–ª—å–Ω–∞—è –†–æ—Å—Å–∏—è ¬∑ –ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Helvetica Neue', sans-serif;
        }

        body {
            background: linear-gradient(145deg, #0a0010 0%, #1a0025 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 0;
            margin: 0;
            color: #f0e6ff;
            position: relative;
            overflow-x: hidden;
        }

        /* –ê–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —á–∞—Å—Ç–∏—Ü—ã —Ñ–∏–æ–ª–µ—Ç–æ–≤–æ–≥–æ —Å–≤–µ—á–µ–Ω–∏—è */
        body::before {
            content: '';
            position: fixed;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at 20% 30%, rgba(170, 0, 255, 0.15) 0%, transparent 40%),
                        radial-gradient(circle at 80% 70%, rgba(120, 0, 200, 0.12) 0%, transparent 45%),
                        radial-gradient(circle at 40% 80%, rgba(200, 0, 255, 0.1) 0%, transparent 50%);
            animation: glowPulse 8s infinite alternate;
            pointer-events: none;
        }

        @keyframes glowPulse {
            0% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        #app {
            width: 100%;
            max-width: 480px;
            height: 100vh;
            max-height: 100vh;
            background: rgba(25, 0, 35, 0.6);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-left: 1px solid rgba(200, 0, 255, 0.3);
            border-right: 1px solid rgba(200, 0, 255, 0.3);
            box-shadow: 0 0 40px rgba(150, 0, 255, 0.3);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        /* –≠—Ñ—Ñ–µ–∫—Ç —Å–≤–µ—á–µ–Ω–∏—è –≥—Ä–∞–Ω–∏—Ü */
        #app::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border: 1px solid rgba(255, 0, 255, 0.1);
            box-shadow: inset 0 0 30px rgba(180, 0, 255, 0.2);
            pointer-events: none;
        }

        .screen {
            display: none;
            flex-direction: column;
            height: 100%;
            width: 100%;
        }

        .active-screen {
            display: flex;
        }

        /* –®–∞–ø–∫–∞ —Å –Ω–µ–æ–Ω–æ–≤—ã–º –∑–∞–≥–æ–ª–æ–≤–∫–æ–º */
        .neon-header {
            padding: 16px 20px;
            background: rgba(20, 0, 30, 0.7);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid #b300ff;
            box-shadow: 0 0 20px #9900ff;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            z-index: 10;
        }

        .neon-title {
            font-size: 24px;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 4px;
            color: #ffffff;
            text-shadow: 0 0 10px #ff00de, 0 0 20px #c000ff, 0 0 30px #a000ff, 0 0 40px #8000ff;
            animation: flicker 3s infinite alternate;
        }

        @keyframes flicker {
            0% { text-shadow: 0 0 10px #ff00de, 0 0 20px #c000ff, 0 0 30px #a000ff; }
            100% { text-shadow: 0 0 15px #ff40ff, 0 0 25px #d020ff, 0 0 45px #a000ff, 0 0 55px #8000ff; }
        }

        .user-badge {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(80, 0, 130, 0.6);
            padding: 6px 12px;
            border-radius: 30px;
            border: 1px solid #d400ff;
            font-size: 14px;
            font-weight: bold;
        }

        .online-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #00ff88;
            box-shadow: 0 0 15px #00ff88;
            animation: pulseOnline 2s infinite;
        }

        @keyframes pulseOnline {
            0% { opacity: 0.8; transform: scale(1); }
            100% { opacity: 1; transform: scale(1.2); }
        }

        .content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* –ö–∞—Ä—Ç–æ—á–∫–∏ –∏ —ç–ª–µ–º–µ–Ω—Ç—ã –≤–≤–æ–¥–∞ */
        .glass-card {
            background: rgba(50, 0, 70, 0.5);
            backdrop-filter: blur(12px);
            border-radius: 24px;
            padding: 20px;
            border: 1px solid rgba(200, 0, 255, 0.5);
            box-shadow: 0 8px 32px rgba(150, 0, 200, 0.3);
        }

        .input-field {
            width: 100%;
            padding: 16px 18px;
            background: rgba(20, 0, 30, 0.8);
            border: 2px solid #a020f0;
            border-radius: 40px;
            font-size: 16px;
            color: white;
            outline: none;
            transition: 0.2s;
            margin-bottom: 15px;
        }

        .input-field:focus {
            border-color: #ff40ff;
            box-shadow: 0 0 25px #bf00ff;
            background: rgba(40, 0, 50, 0.9);
        }

        .btn {
            background: linear-gradient(45deg, #6a0dad, #b300ff);
            border: none;
            border-radius: 40px;
            padding: 16px 20px;
            color: white;
            font-weight: bold;
            font-size: 16px;
            text-transform: uppercase;
            letter-spacing: 2px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 0 20px #8a2be2;
            transition: 0.2s;
            cursor: pointer;
        }

        .btn:active {
            transform: scale(0.97);
            box-shadow: 0 0 35px #bf00ff;
        }

        .id-display {
            background: rgba(0, 0, 0, 0.6);
            padding: 15px;
            border-radius: 20px;
            border: 1px dashed #ff44ff;
            font-size: 28px;
            font-weight: 800;
            text-align: center;
            letter-spacing: 8px;
            color: #ffffff;
            text-shadow: 0 0 15px cyan;
            margin: 10px 0;
        }

        /* –°–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤ */
        .chat-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .chat-item {
            background: rgba(75, 0, 130, 0.5);
            backdrop-filter: blur(5px);
            padding: 16px;
            border-radius: 20px;
            border-left: 8px solid #b300ff;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* –°–æ–æ–±—â–µ–Ω–∏—è */
        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .message {
            max-width: 80%;
            padding: 12px 16px;
            border-radius: 24px;
            position: relative;
            word-break: break-word;
        }

        .my-message {
            align-self: flex-end;
            background: linear-gradient(145deg, #7a1fa0, #4a0072);
            border-bottom-right-radius: 4px;
            box-shadow: 0 0 20px #b300ff70;
        }

        .other-message {
            align-self: flex-start;
            background: rgba(40, 0, 60, 0.8);
            border: 1px solid #cc66ff;
            border-bottom-left-radius: 4px;
        }

        .typing-indicator {
            color: #d4a0ff;
            font-style: italic;
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 8px 15px;
            background: rgba(100, 0, 150, 0.3);
            border-radius: 30px;
            align-self: flex-start;
            animation: typingPulse 1.5s infinite;
        }

        @keyframes typingPulse {
            0% { opacity: 0.7; }
            100% { opacity: 1; text-shadow: 0 0 8px #ffaaff; }
        }

        .message-time {
            font-size: 11px;
            color: #ccccff;
            margin-top: 5px;
            text-align: right;
        }

        .last-seen {
            font-size: 12px;
            color: #bb99ff;
        }

        /* –ù–∏–∂–Ω–µ–µ –º–µ–Ω—é */
        .bottom-nav {
            display: flex;
            justify-content: space-around;
            background: rgba(16, 0, 20, 0.9);
            backdrop-filter: blur(15px);
            padding: 12px 10px;
            border-top: 1px solid #a64dff;
            box-shadow: 0 -5px 30px #6a0dad;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: #d0b0ff;
            font-size: 12px;
            gap: 4px;
            transition: 0.2s;
        }

        .nav-item.active {
            color: #ffbbff;
            text-shadow: 0 0 15px #ff00ff;
        }

        .nav-icon {
            font-size: 22px;
        }

        /* –ê–∫–∫–∞—É–Ω—Ç—ã */
        .accounts-grid {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .account-item {
            background: rgba(80, 0, 120, 0.4);
            padding: 15px;
            border-radius: 18px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid #c061ff;
        }

        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- –≠–ö–†–ê–ù –í–•–û–î–ê / –†–ï–ì–ò–°–¢–†–ê–¶–ò–ò -->
        <div id="auth-screen" class="screen active-screen">
            <div class="neon-header">
                <span class="neon-title">–ö–†–ò–ú–ò–ù–ê–õ–¨–ù–ê–Ø –†–û–°–°–ò–Ø</span>
            </div>
            <div class="content">
                <div class="glass-card" style="margin-top: 30px;">
                    <h2 style="margin-bottom: 20px; text-align: center; text-shadow: 0 0 10px violet;">–í–æ–π—Ç–∏ –≤ –∫—Ä–∏–º–∏–Ω–∞–ª</h2>
                    <input type="text" id="login-username" class="input-field" placeholder="–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è" autocomplete="off">
                    <button id="login-btn" class="btn">–í–æ–π—Ç–∏ / –°–æ–∑–¥–∞—Ç—å</button>
                </div>
                <div style="text-align: center; margin-top: 20px; color: #d0a0ff;">
                    –í–∞–º –±—É–¥–µ—Ç –ø—Ä–∏—Å–≤–æ–µ–Ω —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID ‚ù§Ô∏è‚Äçüî•
                </div>
            </div>
        </div>

        <!-- –û–°–ù–û–í–ù–û–ô –≠–ö–†–ê–ù –ß–ê–¢–û–í -->
        <div id="main-screen" class="screen">
            <div class="neon-header">
                <span class="neon-title">–ß–ê–¢–´</span>
                <div id="current-user-badge" class="user-badge">
                    <span class="online-indicator"></span>
                    <span id="current-username">... </span>
                </div>
            </div>
            
            <div class="content" id="main-content">
                <!-- –°–ø–∏—Å–æ–∫ –¥–∏–∞–ª–æ–≥–æ–≤ -->
                <div id="chats-list-container">
                    <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                        <input type="text" id="search-user-id" class="input-field" placeholder="–í–≤–µ–¥–∏—Ç–µ ID —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞" style="margin-bottom: 0;">
                        <button id="start-chat-btn" class="btn" style="width: auto; padding: 16px 20px;">‚ûï</button>
                    </div>
                    <div id="chats-list" class="chat-list"></div>
                </div>

                <!-- –û–∫–Ω–æ –ø–µ—Ä–µ–ø–∏—Å–∫–∏ (—Å–∫—Ä—ã—Ç–æ –ø–æ–∫–∞ –Ω–µ –≤—ã–±—Ä–∞–Ω —á–∞—Ç) -->
                <div id="chat-window" class="hidden" style="height: 100%; display: flex; flex-direction: column;">
                    <div style="display: flex; align-items: center; gap: 15px; padding-bottom: 15px; border-bottom: 1px solid #b300ff;">
                        <button id="back-to-chats" style="background: none; border: none; font-size: 28px; color: #fff;">‚Üê</button>
                        <div>
                            <div style="font-weight: bold; font-size: 18px;" id="chat-partner-name">ID: </div>
                            <div class="last-seen" id="chat-partner-status">–ø–æ—Å–ª–µ–¥–Ω–∏–π —Ä–∞–∑: ...</div>
                        </div>
                    </div>
                    
                    <div id="messages-list" class="messages-container" style="flex: 1; overflow-y: auto;">
                        <!-- –°–æ–æ–±—â–µ–Ω–∏—è –ø–æ–¥–≥—Ä—É–∂–∞—é—Ç—Å—è —Å—é–¥–∞ -->
                    </div>

                    <!-- –ü–µ—á–∞—Ç–∞–µ—Ç –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä -->
                    <div id="typing-notification" class="typing-indicator hidden" style="margin-left: 15px; margin-bottom: 5px;">
                        <span>‚úçÔ∏è –ü–µ—á–∞—Ç–∞–µ—Ç...</span>
                    </div>

                    <div style="display: flex; gap: 12px; padding: 15px 0;">
                        <input type="text" id="message-input" class="input-field" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." style="margin-bottom: 0;">
                        <button id="send-message-btn" class="btn" style="width: auto; padding: 16px 24px;">‚û§</button>
                    </div>
                </div>
            </div>

            <div class="bottom-nav">
                <div class="nav-item active" id="nav-chats">
                    <span class="nav-icon">üí¨</span>
                    <span>–ß–∞—Ç—ã</span>
                </div>
                <div class="nav-item" id="nav-settings">
                    <span class="nav-icon">‚öôÔ∏è</span>
                    <span>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</span>
                </div>
            </div>
        </div>

        <!-- –≠–ö–†–ê–ù –ù–ê–°–¢–†–û–ï–ö -->
        <div id="settings-screen" class="screen">
            <div class="neon-header">
                <span class="neon-title">–ù–ê–°–¢–†–û–ô–ö–ò</span>
                <div class="user-badge">
                    <span id="settings-username">user</span>
                </div>
            </div>
            <div class="content">
                <div class="glass-card">
                    <h3 style="margin-bottom: 15px;">üîÆ –¢–≤–æ–π —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID</h3>
                    <div id="user-unique-id" class="id-display">00000</div>
                    <p style="margin-top: 15px; color: #e6ccff;">–ü–æ —ç—Ç–æ–º—É ID —Ç–µ–±—è –º–æ–≥—É—Ç –Ω–∞–π—Ç–∏ –¥—Ä—É–≥–∏–µ</p>
                </div>

                <div class="glass-card" style="margin-top: 20px;">
                    <h3 style="margin-bottom: 20px;">üë• –°–ø–∏—Å–æ–∫ –∞–∫–∫–∞—É–Ω—Ç–æ–≤</h3>
                    <div id="accounts-list-container" class="accounts-grid"></div>
                    <button id="add-new-account-btn" class="btn" style="margin-top: 20px;">‚ûï –î–æ–±–∞–≤–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç</button>
                </div>

                <button id="logout-from-settings" class="btn" style="margin-top: 20px; background: linear-gradient(45deg, #4b0082, #8a2be2);">–í—ã–π—Ç–∏</button>
            </div>
            <div class="bottom-nav">
                <div class="nav-item" id="nav-chats-from-settings">
                    <span class="nav-icon">üí¨</span>
                    <span>–ß–∞—Ç—ã</span>
                </div>
                <div class="nav-item active">
                    <span class="nav-icon">‚öôÔ∏è</span>
                    <span>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // üî• FIREBASE –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø
        const firebaseConfig = {
            apiKey: "AIzaSyAu_wfaRhTsWNbsyFYmEigopqJck7ynxlU",
            authDomain: "messeger-0wo2h4.firebaseapp.com",
            databaseURL: "https://messeger-0wo2h4-default-rtdb.firebaseio.com",
            projectId: "messeger-0wo2h4",
            storageBucket: "messeger-0wo2h4.firebasestorage.app",
            messagingSenderId: "1057251395030",
            appId: "1:1057251395030:web:86f8f718ed938055e29077"
        };

        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // ================== –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ==================
        let currentUser = null;           // { id, name, uid }
        let currentChatPartner = null;    // ID —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞
        let allAccounts = [];            // –º–∞—Å—Å–∏–≤ –∞–∫–∫–∞—É–Ω—Ç–æ–≤ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è

        // –≠–ª–µ–º–µ–Ω—Ç—ã DOM
        const authScreen = document.getElementById('auth-screen');
        const mainScreen = document.getElementById('main-screen');
        const settingsScreen = document.getElementById('settings-screen');
        const loginBtn = document.getElementById('login-btn');
        const loginUsername = document.getElementById('login-username');
        const currentUsernameSpan = document.getElementById('current-username');
        const settingsUsernameSpan = document.getElementById('settings-username');
        const userUniqueIdSpan = document.getElementById('user-unique-id');
        const chatsListEl = document.getElementById('chats-list');
        const chatWindow = document.getElementById('chat-window');
        const chatsListContainer = document.getElementById('chats-list-container');
        const messagesListEl = document.getElementById('messages-list');
        const messageInput = document.getElementById('message-input');
        const sendMsgBtn = document.getElementById('send-message-btn');
        const searchUserId = document.getElementById('search-user-id');
        const startChatBtn = document.getElementById('start-chat-btn');
        const backToChats = document.getElementById('back-to-chats');
        const chatPartnerName = document.getElementById('chat-partner-name');
        const chatPartnerStatus = document.getElementById('chat-partner-status');
        const typingNotification = document.getElementById('typing-notification');

        // –ù–∞–≤–∏–≥–∞—Ü–∏—è
        document.getElementById('nav-settings').addEventListener('click', () => showSettingsScreen());
        document.getElementById('nav-chats-from-settings').addEventListener('click', () => showMainScreen());
        document.getElementById('nav-chats').addEventListener('click', () => showMainScreen());
        document.getElementById('logout-from-settings').addEventListener('click', logout);
        document.getElementById('add-new-account-btn').addEventListener('click', () => { logout(); });

        backToChats.addEventListener('click', () => {
            chatWindow.classList.add('hidden');
            chatsListContainer.classList.remove('hidden');
        });

        // ================== –§–£–ù–ö–¶–ò–ò –í–†–ï–ú–ï–ù–ò –ú–°–ö ==================
        function getMoscowTime() {
            const now = new Date();
            const mskOffset = 3 * 60; // +3 UTC
            const localOffset = now.getTimezoneOffset();
            const mskTime = new Date(now.getTime() + (mskOffset + localOffset) * 60000);
            return mskTime;
        }

        function formatLastSeen(timestamp) {
            if (!timestamp) return '–Ω–∏–∫–æ–≥–¥–∞';
            const last = new Date(timestamp);
            const now = getMoscowTime();
            const diffMs = now - last;
            const diffMin = Math.floor(diffMs / 60000);
            if (diffMin < 1) return '—Ç–æ–ª—å–∫–æ —á—Ç–æ';
            if (diffMin < 60) return `${diffMin} –º–∏–Ω –Ω–∞–∑–∞–¥`;
            if (diffMin < 1440) return `${Math.floor(diffMin / 60)} —á –Ω–∞–∑–∞–¥`;
            return last.toLocaleDateString('ru-RU', { day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' });
        }

        // ================== –ì–ï–ù–ï–†–ê–¶–ò–Ø –£–ù–ò–ö–ê–õ–¨–ù–û–ì–û ID (5 –°–ò–ú–í–û–õ–û–í) ==================
        function generateUniqueId() {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ0123456789';
            let id = '';
            for (let i = 0; i < 5; i++) {
                id += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return id;
        }

        // ================== –†–ê–ë–û–¢–ê –° –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø–ú–ò ==================
        async function loginUser(username) {
            if (!username.trim()) return alert('–í–≤–µ–¥–∏—Ç–µ –∏–º—è');
            const usersRef = database.ref('users');
            const snapshot = await usersRef.orderByChild('name').equalTo(username).once('value');
            let userData;
            let userId;

            if (snapshot.exists()) {
                // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
                const entries = Object.entries(snapshot.val());
                userId = entries[0][0];
                userData = entries[0][1];
            } else {
                // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤–æ–≥–æ
                userId = generateUniqueId();
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å ID (–Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π)
                const idCheck = await usersRef.child(userId).once('value');
                if (idCheck.exists()) {
                    userId = generateUniqueId(); // –ø–æ–≤—Ç–æ—Ä
                }
                userData = {
                    name: username,
                    id: userId,
                    lastSeen: firebase.database.ServerValue.TIMESTAMP,
                    online: true
                };
                await usersRef.child(userId).set(userData);
            }

            currentUser = { ...userData, uid: userId };
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage
            let accounts = JSON.parse(localStorage.getItem('criminal_accounts') || '[]');
            if (!accounts.find(acc => acc.uid === userId)) {
                accounts.push({ uid: userId, name: username });
                localStorage.setItem('criminal_accounts', JSON.stringify(accounts));
            }
            localStorage.setItem('current_account', JSON.stringify({ uid: userId, name: username }));

            await setUserOnlineStatus(userId, true);
            loadAllAccounts();
            updateUIForUser();
            showMainScreen();
        }

        async function setUserOnlineStatus(uid, status) {
            if (!uid) return;
            await database.ref(`users/${uid}`).update({
                online: status,
                lastSeen: firebase.database.ServerValue.TIMESTAMP
            });
        }

        // ================== –ó–ê–ì–†–£–ó–ö–ê –í–°–ï–• –ê–ö–ö–ê–£–ù–¢–û–í ==================
        function loadAllAccounts() {
            const stored = localStorage.getItem('criminal_accounts');
            allAccounts = stored ? JSON.parse(stored) : [];
            renderAccountsList();
        }

        function renderAccountsList() {
            const container = document.getElementById('accounts-list-container');
            if (!container) return;
            let html = '';
            allAccounts.forEach(acc => {
                html += `<div class="account-item">
                            <span style="font-weight: bold;">${acc.name}</span>
                            <span style="background: #6a0dad; padding: 6px 12px; border-radius: 30px;">ID: ${acc.uid}</span>
                            <button onclick="switchAccount('${acc.uid}')" class="btn" style="padding: 8px 16px;">üîÅ</button>
                        </div>`;
            });
            container.innerHTML = html || '<p style="color: #ccc;">–ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –∞–∫–∫–∞—É–Ω—Ç–æ–≤</p>';
        }

        window.switchAccount = async function(uid) {
            const usersRef = database.ref('users');
            const snap = await usersRef.child(uid).once('value');
            if (snap.exists()) {
                const userData = snap.val();
                currentUser = { ...userData, uid };
                localStorage.setItem('current_account', JSON.stringify({ uid, name: userData.name }));
                await setUserOnlineStatus(uid, true);
                updateUIForUser();
                showMainScreen();
            }
        };

        // ================== –û–ë–ù–û–í–õ–ï–ù–ò–ï –ò–ù–¢–ï–†–§–ï–ô–°–ê ==================
        function updateUIForUser() {
            if (currentUser) {
                currentUsernameSpan.textContent = currentUser.name;
                settingsUsernameSpan.textContent = currentUser.name;
                userUniqueIdSpan.textContent = currentUser.id;
            }
        }

        // ================== –ó–ê–ì–†–£–ó–ö–ê –ß–ê–¢–û–í ==================
        function loadChats() {
            if (!currentUser) return;
            const userId = currentUser.uid;
            const chatsRef = database.ref('chats');

            chatsRef.orderByChild(`participants/${userId}`).equalTo(true).on('value', (snapshot) => {
                if (!snapshot.exists()) {
                    chatsListEl.innerHTML = '<div style="color: #bb99ff; text-align: center;">–ù–µ—Ç —á–∞—Ç–æ–≤. –ù–∞—á–Ω–∏—Ç–µ –ø–µ—Ä–µ–ø–∏—Å–∫—É –ø–æ ID!</div>';
                    return;
                }
                let chatsHtml = '';
                const chats = snapshot.val();
                for (const chatId in chats) {
                    const chat = chats[chatId];
                    const participants = Object.keys(chat.participants || {});
                    const partnerId = participants.find(p => p !== userId);
                    if (partnerId) {
                        // –ü–æ–ª—É—á–∞–µ–º –∏–º—è –ø–∞—Ä—Ç–Ω–µ—Ä–∞
                        database.ref(`users/${partnerId}`).once('value').then(partnerSnap => {
                            if (partnerSnap.exists()) {
                                const pData = partnerSnap.val();
                                // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                                const chatItem = document.querySelector(`.chat-item[data-chatid="${chatId}"] .chat-name`);
                                if (chatItem) chatItem.textContent = `${pData.name} (${partnerId})`;
                            }
                        });
                        chatsHtml += `<div class="chat-item" onclick="openChat('${partnerId}')" data-chatid="${chatId}">
                                        <div>
                                            <div style="font-weight: bold; margin-bottom: 5px;" class="chat-name">ID: ${partnerId}</div>
                                            <div style="font-size: 13px; color: #dec5ff;">üë§ ${partnerId}</div>
                                        </div>
                                        <div style="font-size: 24px;">üí¨</div>
                                    </div>`;
                    }
                }
                chatsListEl.innerHTML = chatsHtml || '<div style="color: #bb99ff;">–ß–∞—Ç–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</div>';
            });
        }

        // ================== –û–¢–ö–†–´–¢–¨ –ß–ê–¢ ==================
        window.openChat = async function(partnerId) {
            currentChatPartner = partnerId;
            chatWindow.classList.remove('hidden');
            chatsListContainer.classList.add('hidden');

            // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–µ
            const userSnap = await database.ref(`users/${partnerId}`).once('value');
            if (userSnap.exists()) {
                const pData = userSnap.val();
                chatPartnerName.textContent = `${pData.name} (${partnerId})`;
            }

            // –°–ª—É—à–∞–µ–º —Å—Ç–∞—Ç—É—Å
            database.ref(`users/${partnerId}`).on('value', (snap) => {
                const user = snap.val();
                if (user) {
                    if (user.online) {
                        chatPartnerStatus.innerHTML = 'üü¢ –≤ —Å–µ—Ç–∏';
                    } else {
                        chatPartnerStatus.textContent = `–±—ã–ª(–∞) ${formatLastSeen(user.lastSeen)}`;
                    }
                }
            });

            // –°–ª—É—à–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è
            const chatId = generateChatId(currentUser.uid, partnerId);
            const messagesRef = database.ref(`messages/${chatId}`);
            messagesRef.off(); // –æ—á–∏—Å—Ç–∫–∞
            messagesRef.orderByChild('timestamp').on('value', (snap) => {
                if (snap.exists()) {
                    renderMessages(snap.val());
                } else {
                    messagesListEl.innerHTML = '<div style="color: #aaa; text-align: center;">–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π. –ù–∞–ø–∏—à–∏—Ç–µ –ø–µ—Ä–≤–æ–µ!</div>';
                }
            });

            // –°–ª—É—à–∞–µ–º "–ø–µ—á–∞—Ç–∞–µ—Ç..."
            database.ref(`typing/${chatId}/${partnerId}`).on('value', (snap) => {
                if (snap.val() === true) {
                    typingNotification.classList.remove('hidden');
                } else {
                    typingNotification.classList.add('hidden');
                }
            });
        };

        function generateChatId(uid1, uid2) {
            return [uid1, uid2].sort().join('_');
        }

        function renderMessages(messagesObj) {
            if (!messagesObj) return;
            let html = '';
            const sorted = Object.values(messagesObj).sort((a,b) => a.timestamp - b.timestamp);
            sorted.forEach(msg => {
                const isMy = msg.sender === currentUser.uid;
                const time = new Date(msg.timestamp).toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
                html += `<div class="message ${isMy ? 'my-message' : 'other-message'}">
                            ${msg.text}
                            <div class="message-time">${time}</div>
                        </div>`;
            });
            messagesListEl.innerHTML = html || '<div style="color: #aaa; text-align: center;">–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π</div>';
        }

        // ================== –û–¢–ü–†–ê–í–ö–ê –°–û–û–ë–©–ï–ù–ò–Ø ==================
        sendMsgBtn.addEventListener('click', sendMessage);
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
            // –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø–µ—á–∞—Ç–∞–µ—Ç
            if (currentChatPartner && currentUser) {
                const chatId = generateChatId(currentUser.uid, currentChatPartner);
                database.ref(`typing/${chatId}/${currentUser.uid}`).set(true);
                setTimeout(() => {
                    database.ref(`typing/${chatId}/${currentUser.uid}`).remove();
                }, 2000);
            }
        });

        async function sendMessage() {
            const text = messageInput.value.trim();
            if (!text || !currentChatPartner || !currentUser) return;

            const chatId = generateChatId(currentUser.uid, currentChatPartner);
            const messageRef = database.ref(`messages/${chatId}`).push();
            await messageRef.set({
                text: text,
                sender: currentUser.uid,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            });

            // –û–±–Ω–æ–≤–ª—è–µ–º —á–∞—Ç –≤ /chats
            const chatParticipants = {};
            chatParticipants[currentUser.uid] = true;
            chatParticipants[currentChatPartner] = true;
            await database.ref(`chats/${chatId}/participants`).set(chatParticipants);

            messageInput.value = '';
        }

        // ================== –ù–ê–ß–ê–¢–¨ –ß–ê–¢ –ü–û ID ==================
        startChatBtn.addEventListener('click', async () => {
            const targetId = searchUserId.value.trim().toUpperCase();
            if (!targetId) return alert('–í–≤–µ–¥–∏—Ç–µ ID');
            if (targetId === currentUser.id) return alert('–≠—Ç–æ –≤–∞—à —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π ID');
            const userSnap = await database.ref(`users/${targetId}`).once('value');
            if (userSnap.exists()) {
                openChat(targetId);
                searchUserId.value = '';
            } else {
                alert('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º ID –Ω–µ –Ω–∞–π–¥–µ–Ω');
            }
        });

        // ================== –í–´–•–û–î ==================
        async function logout() {
            if (currentUser) {
                await setUserOnlineStatus(currentUser.uid, false);
                currentUser = null;
            }
            authScreen.classList.add('active-screen');
            mainScreen.classList.remove('active-screen');
            settingsScreen.classList.remove('active-screen');
        }

        // ================== –ü–û–ö–ê–ó –≠–ö–†–ê–ù–û–í ==================
        function showMainScreen() {
            authScreen.classList.remove('active-screen');
            mainScreen.classList.add('active-screen');
            settingsScreen.classList.remove('active-screen');
            chatWindow.classList.add('hidden');
            chatsListContainer.classList.remove('hidden');
            if (currentUser) {
                loadChats();
                updateUIForUser();
            }
        }

        function showSettingsScreen() {
            authScreen.classList.remove('active-screen');
            mainScreen.classList.remove('active-screen');
            settingsScreen.classList.add('active-screen');
            if (currentUser) {
                userUniqueIdSpan.textContent = currentUser.id;
                settingsUsernameSpan.textContent = currentUser.name;
                loadAllAccounts();
            }
        }

        // ================== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ==================
        window.onload = async () => {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ–∫—É—â—É—é —Å–µ—Å—Å–∏—é
            const savedAccount = localStorage.getItem('current_account');
            if (savedAccount) {
                const acc = JSON.parse(savedAccount);
                const userSnap = await database.ref(`users/${acc.uid}`).once('value');
                if (userSnap.exists()) {
                    const userData = userSnap.val();
                    currentUser = { ...userData, uid: acc.uid };
                    await setUserOnlineStatus(acc.uid, true);
                    updateUIForUser();
                    showMainScreen();
                } else {
                    localStorage.removeItem('current_account');
                }
            }

            loginBtn.addEventListener('click', () => loginUser(loginUsername.value));
            loadAllAccounts();
        };

        // –ü—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã ‚Äî –æ—Ñ–ª–∞–π–Ω
        window.addEventListener('beforeunload', function() {
            if (currentUser) {
                setUserOnlineStatus(currentUser.uid, false);
            }
        });
    </script>
</body>
</html>